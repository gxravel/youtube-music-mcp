---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - .gitignore
  - .env.example
  - internal/config/config.go
  - internal/auth/oauth.go
  - internal/auth/token_storage.go
autonomous: true
user_setup:
  - service: google-cloud
    why: "OAuth2 credentials required for YouTube API access"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (type: Web application)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials"
      - task: "Add authorized redirect URI: http://localhost:8080/callback"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Edit OAuth Client"
      - task: "Enable YouTube Data API v3"
        location: "Google Cloud Console -> APIs & Services -> Library -> YouTube Data API v3 -> Enable"
      - task: "Configure OAuth consent screen (Testing or Production status)"
        location: "Google Cloud Console -> APIs & Services -> OAuth consent screen"

must_haves:
  truths:
    - "Go module initializes and dependencies resolve"
    - "Config loads GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET from environment"
    - "OAuth2 flow generates authorization URL with offline access and youtube.readonly scope"
    - "Local callback server receives authorization code and exchanges it for token"
    - "Token is persisted to ~/.config/youtube-music-mcp/token.json with 0600 permissions"
    - "Token loads from disk on subsequent runs without re-prompting"
    - "Token refresh is captured and persisted automatically via PersistingTokenSource"
  artifacts:
    - path: "go.mod"
      provides: "Go module definition with dependencies"
      contains: "github.com/gxravel/youtube-music-mcp"
    - path: ".gitignore"
      provides: "Git ignore rules for secrets and build artifacts"
      contains: ".env"
    - path: ".env.example"
      provides: "Template for required environment variables"
      contains: "GOOGLE_CLIENT_ID"
    - path: "internal/config/config.go"
      provides: "Environment variable configuration loading"
      exports: ["Config", "Load"]
    - path: "internal/auth/oauth.go"
      provides: "OAuth2 flow with local callback server"
      exports: ["NewOAuth2Config", "Authenticate"]
    - path: "internal/auth/token_storage.go"
      provides: "File-based token persistence with atomic writes"
      exports: ["TokenStorage", "FileTokenStorage", "NewFileTokenStorage", "PersistingTokenSource"]
  key_links:
    - from: "internal/auth/oauth.go"
      to: "internal/config/config.go"
      via: "Config struct provides OAuth2 credentials"
      pattern: "config\\.Config"
    - from: "internal/auth/oauth.go"
      to: "internal/auth/token_storage.go"
      via: "OAuth flow saves token via TokenStorage interface"
      pattern: "TokenStorage"
    - from: "internal/auth/token_storage.go"
      to: "~/.config/youtube-music-mcp/token.json"
      via: "Atomic file write (temp + rename)"
      pattern: "os\\.Rename"
---

<objective>
Set up the Go project foundation with module initialization, environment configuration, and the complete OAuth2 authentication package including token persistence with automatic refresh capture.

Purpose: Establish the project skeleton and authentication layer that all subsequent phases depend on. Without working OAuth2 + token persistence, no YouTube API calls are possible.
Output: Go module with config and auth packages ready to be wired into the MCP server (Plan 02).
</objective>

<execution_context>
@/home/gxravel/.claude/get-shit-done/workflows/execute-plan.md
@/home/gxravel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Go module with dependencies and project scaffolding</name>
  <files>go.mod, go.sum, .gitignore, .env.example</files>
  <action>
    1. Initialize Go module: `go mod init github.com/gxravel/youtube-music-mcp`

    2. Install core dependencies:
       ```
       go get github.com/modelcontextprotocol/go-sdk@latest
       go get google.golang.org/api/youtube/v3@latest
       go get golang.org/x/oauth2/google@latest
       go get github.com/caarlos0/env/v11@latest
       go get github.com/joho/godotenv@latest
       ```

    3. Create `.gitignore` with:
       ```
       # Environment and secrets
       .env
       token.json
       credentials.json

       # Go build artifacts
       /bin/
       *.exe
       *.exe~
       *.dll
       *.so
       *.dylib

       # Go test artifacts
       *.test
       *.out
       cover.out
       coverage.html

       # IDE
       .idea/
       .vscode/
       *.swp
       *.swo

       # OS
       .DS_Store
       Thumbs.db
       ```

    4. Create `.env.example` with:
       ```
       # Required: Google OAuth2 credentials
       # Get from: Google Cloud Console -> APIs & Services -> Credentials
       GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
       GOOGLE_CLIENT_SECRET=your-client-secret

       # Optional: OAuth redirect URL (default: http://localhost:8080/callback)
       OAUTH_REDIRECT_URL=http://localhost:8080/callback

       # Optional: OAuth callback server port (default: 8080)
       OAUTH_PORT=8080
       ```

    5. Create directory structure:
       ```
       mkdir -p cmd/server internal/auth internal/config internal/youtube internal/server
       ```

    6. Run `go mod tidy` to clean up dependencies.
  </action>
  <verify>
    - `go mod tidy` exits cleanly (exit code 0)
    - `go.mod` contains all 5 dependencies
    - `.gitignore` exists and contains `.env`
    - `.env.example` exists and contains `GOOGLE_CLIENT_ID`
    - All directories exist: cmd/server, internal/auth, internal/config, internal/youtube, internal/server
  </verify>
  <done>Go module initialized with all dependencies resolved, project directory structure created, .gitignore and .env.example in place.</done>
</task>

<task type="auto">
  <name>Task 2: Create config package and auth package with OAuth2 flow and token persistence</name>
  <files>internal/config/config.go, internal/auth/oauth.go, internal/auth/token_storage.go</files>
  <action>
    **internal/config/config.go:**

    Create Config struct with environment variable parsing using `caarlos0/env/v11`:
    - `GoogleClientID string` — `env:"GOOGLE_CLIENT_ID,required"` — Google OAuth2 client ID
    - `GoogleClientSecret string` — `env:"GOOGLE_CLIENT_SECRET,required"` — Google OAuth2 client secret
    - `OAuthRedirectURL string` — `env:"OAUTH_REDIRECT_URL" envDefault:"http://localhost:8080/callback"` — OAuth callback URL
    - `OAuthPort int` — `env:"OAUTH_PORT" envDefault:"8080"` — Port for local OAuth callback server

    Create `Load() (*Config, error)` function:
    - Call `godotenv.Load()` first (ignore error — .env is optional)
    - Parse env vars into Config struct using `env.Parse()`
    - Return config or error

    **internal/auth/token_storage.go:**

    Define `TokenStorage` interface:
    - `Load() (*oauth2.Token, error)` — load token from storage
    - `Save(token *oauth2.Token) error` — persist token to storage

    Implement `FileTokenStorage` struct:
    - Field: `path string` (full path to token file)
    - Constructor: `NewFileTokenStorage(path string) *FileTokenStorage`
    - Default path helper: `DefaultTokenPath() string` returning `~/.config/youtube-music-mcp/token.json` (use `os.UserConfigDir()` if available, fallback to `$HOME/.config`)
    - `Load()`: Read file, unmarshal JSON to `oauth2.Token`, return token or error
    - `Save()`: Marshal token to indented JSON, atomic write (write to `path + ".tmp"`, then `os.Rename` to `path`), create parent directory with `0700` permissions, file with `0600` permissions

    Implement `PersistingTokenSource` struct (wraps `oauth2.TokenSource` to capture refreshes):
    - Fields: `base oauth2.TokenSource`, `storage TokenStorage`, `logger *slog.Logger`, `mu sync.Mutex`, `lastToken *oauth2.Token`
    - Constructor: `NewPersistingTokenSource(base oauth2.TokenSource, storage TokenStorage, logger *slog.Logger) *PersistingTokenSource`
    - `Token() (*oauth2.Token, error)`: Call `base.Token()`, compare with `lastToken` — if different (refreshed), save via `storage.Save()` and log refresh event at INFO level. Use mutex for thread safety. Update `lastToken`.

    **internal/auth/oauth.go:**

    Create `NewOAuth2Config(clientID, clientSecret, redirectURL string) *oauth2.Config`:
    - Endpoint: `google.Endpoint`
    - Scopes: `[]string{youtube.YoutubeReadonlyScope}`
    - Set ClientID, ClientSecret, RedirectURL from params

    Create `Authenticate(ctx context.Context, cfg *oauth2.Config, storage TokenStorage, port int, logger *slog.Logger) (*http.Client, error)`:
    1. Try `storage.Load()` — if successful, create token source with `cfg.TokenSource(ctx, token)`, wrap in `PersistingTokenSource`, return `oauth2.NewClient(ctx, persistingSource)`
    2. If load fails (no saved token), start OAuth2 web flow:
       a. Generate auth URL with `cfg.AuthCodeURL("state", oauth2.AccessTypeOffline, oauth2.SetAuthParam("prompt", "consent"))` — `prompt=consent` forces refresh token on re-auth
       b. Print auth URL to stderr: `fmt.Fprintf(os.Stderr, "\nVisit this URL to authorize:\n%s\n\n", authURL)`
       c. Start local HTTP server on `port` with `/callback` handler
       d. Callback handler extracts `code` param, sends to channel, responds with "Authorization successful! You can close this window."
       e. Wait for code from channel (with context cancellation support)
       f. Shut down callback server
       g. Exchange code: `cfg.Exchange(ctx, code)`
       h. Save token via `storage.Save(token)`
       i. Create token source, wrap in `PersistingTokenSource`, return `oauth2.NewClient(ctx, persistingSource)`

    IMPORTANT: All logging MUST go to stderr via the provided slog.Logger. NEVER use fmt.Printf or fmt.Println — only fmt.Fprintf(os.Stderr, ...) for the auth URL prompt.
  </action>
  <verify>
    - `go build ./internal/config/...` compiles without errors
    - `go build ./internal/auth/...` compiles without errors
    - `go vet ./internal/...` reports no issues
    - Config struct has all 4 fields with correct env tags
    - TokenStorage interface has Load and Save methods
    - FileTokenStorage implements TokenStorage (compiler check via interface assertion)
    - PersistingTokenSource implements oauth2.TokenSource (compiler check via interface assertion)
    - Authenticate function signature accepts all required params
  </verify>
  <done>Config package loads environment variables. Auth package provides complete OAuth2 flow with local callback server, file-based token persistence using atomic writes, and PersistingTokenSource that captures and saves refreshed tokens automatically.</done>
</task>

</tasks>

<verification>
1. `go build ./...` — all packages compile
2. `go vet ./...` — no static analysis issues
3. Config, TokenStorage, FileTokenStorage, PersistingTokenSource types exist and are exported
4. Authenticate function compiles with correct signature
5. .gitignore excludes .env and token.json
6. .env.example documents all required environment variables
</verification>

<success_criteria>
- Go module with all dependencies resolved (`go mod tidy` clean)
- Config package loads Google OAuth2 credentials from environment
- Auth package provides OAuth2 web flow with local callback server
- Token storage persists tokens atomically to ~/.config/youtube-music-mcp/token.json
- PersistingTokenSource wraps oauth2.TokenSource to capture and save refreshed tokens
- All code compiles and passes go vet
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
